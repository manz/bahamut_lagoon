import struct
from a816.cpu.cpu_65c816 import snes_to_rom
import xml.etree.ElementTree as ET

from utils.vm.room import prettify

draw_inline_string_xrefs = [15626092, 15626155, 15626168, 15626212, 15626225, 15626272, 15626341, 15626406,
                            15626419, 15626531, 15626544, 15629211, 15629238, 15630172, 15630288, 15630773,
                            15630790, 15630809, 15630826, 15630847, 15630874, 15630907, 15630946, 15630983,
                            15631161, 15631180, 15631199, 15631225, 15631246, 15631263, 15631280, 15631317,
                            15633795, 15634295, 15634384, 15634425, 15635789, 15635918, 15636008, 15636049,
                            15636103, 15636176, 15636276, 15636322, 15636389, 15636447, 15636505, 15636563,
                            15636698, 15639826, 15640128, 15640154, 15640397, 15641666, 15642067, 15642122,
                            15642163, 15642230, 15642283, 15642338, 15642374, 15642424, 15642474, 15642524,
                            15642683, 15642700, 15644421, 15644520, 15644560, 15644621, 15644672, 15644723,
                            15644774, 15644878, 15644936, 15647141, 15649720, 15651484, 15651519, 15651554,
                            15651584, 15651599, 15651794, 15651819, 15651844, 15652215, 15652265, 15652309,
                            15653543, 15654266, 15654304, 15654319, 15654334, 15654351, 15655890, 15655948,
                            15656039, 15656227, 15656630, 15656651, 15656677, 15658920, 15658941, 15658967,
                            15659188, 15659203, 15659281, 15659298, 15659317, 15659336, 15659355, 15659372,
                            15659548, 15659578, 15659629, 15659646, 15659663, 15659680, 15659704, 15659717,
                            15659732, 15659751, 15659770, 15659804, 15659845, 15659866, 15661564]


def dump_inline_string(rom_file, root, xref):
    rom_file.seek(snes_to_rom(xref) + 3)
    raw_string = b''
    while rom_file.peek(2)[:2] != b'\xff\xff':
        raw = rom_file.read(2)
        if raw != b'\x81\x40':
            raw_string += raw
        else:
            raw_string += b'\x20'

    jap_text = raw_string.decode('shift-jis')
    string = ET.SubElement(inline, 'string')
    string.set('ref', hex(xref))
    string.text = jap_text


if __name__ == '__main__':
    with open('../text/inline_jp.xml', 'wt', encoding='utf-8') as inline_jp:
        with open('../bl.sfc', 'rb') as rom_file:
            inline = ET.Element('inline')

            for xref in draw_inline_string_xrefs:
                dump_inline_string(rom_file, inline, xref)

            inline_jp.write(prettify(inline))
